@{
    ViewBag.Title = "Notification";
}
<script type="text/javascript">
  var line = 0;

  function verifyEmail(targetVal) {
      var status = false;
      var emailRegEx = /^[A-Z0-9._%+-]+@@[A-Z0-9.-]+\.[A-Z]{2,4}$/i;

      if (targetVal.search(emailRegEx) == -1) {
          status = false;
      }
      else {
          status = true;
      }
      return status;
  }

  function addElement(tag_type, parameters) {
      //Create element
      var newElement = document.createElement(tag_type);

      //Add parameters
      if (typeof parameters != 'undefined') {
          for (parameter_name in parameters) {
              newElement.setAttribute(parameter_name, parameters[parameter_name]);
          }
      }

      return newElement;
  }

  function AddNew() {
      var tbl = document.getElementById('tblRecipient');
      var row = tbl.insertRow(-1);
      row.id = "row" + line;

      for (i = 0; i < 6; i++) {
          row.insertCell(0);
      }

      row.cells[0].innerHTML = "Name";
      row.cells[1].appendChild(addElement('INPUT', { id: 'name' + line, name: 'name' + line, type: 'text', size: '5' }));
      row.cells[3].innerHTML = "Email";
      row.cells[4].appendChild(addElement('INPUT', { id: 'email' + line, name: 'email' + line, type: 'text', size: '5' }));
      b = addElement('INPUT', { id: 'btnDelete' + line, name: 'btnDelete' + line, type: 'button', value: 'Delete' })
      row.cells[5].appendChild(b);
      b.setAttribute('onclick', 'DeleteRow(' + line + ')'); 

      line = line + 1;
  }

  function DeleteRow(row) {
      if (line > 0) {
          var tbl = document.getElementById('tblRecipient');
          document.getElementById("row" + row).removeNode(true);
      }
  }

  function compileData() {
      var tbl = document.getElementById('tblRecipient');
      var kept = "";

      if (tbl.rows.length > 0) {
          for (i = 0; i < tbl.rows.length; i++) {
              a = tbl.rows[i].id;
              b = a.substring(3, a.length);
              kept = kept + document.getElementById("name" + b).value + "#";
              kept = kept + document.getElementById("email" + b).value + "|";
          }
      }

      return kept;
  }

  function verifyAllEmail() {
      var status = true;
      var tbl = document.getElementById('tblRecipient');

      if (tbl.rows.length > 0) {            
          for (i = 0; i < tbl.rows.length; i++) {
              a = tbl.rows[i].id;
              b = a.substring(3, a.length);
               
              if (verifyEmail(document.getElementById("email" + b).value) == false)
                  status = false;
          }
      }
  
      return status;
  }
  
  function enoughRow() {
      var status = true;
      var tbl = document.getElementById('tblRecipient');
  
      if (tbl.rows.length > 0)
          return true;
      else
          return false;
  }
  
  function verifyForm() {
      a = document.getElementById("subject").value;
      b = document.getElementById("message").value;
  
      if (a.length < 3 || b.length < 3)
          return false;
      else
          return true;
  }
  
  jQuery(document).ready(function ($) {
      $("#dialog:ui-dialog").dialog("destroy");
  
      $('#btnAdd').click(function () {
          AddNew();
      });
  
      $('#btnSent').click(function () {
          if (verifyForm()) {
              if (enoughRow()) {
                  if (verifyAllEmail()) {
                      $.ajax({
                          url: "/Job/SendNotification",
                          type: "POST",
                          dataType: "html",
                          data: {
                              "subject": document.getElementById("subject").value,
                              "message": document.getElementById("message").value,
                              "from": "temp user",
                              "recipient": compileData(),
                              "random": Math.random()
                          },
                          beforeSend: function () {
  
                          },
                          success: function (data) {
                              var res = jQuery.parseJSON(data);
  
                              if (res.result == "ok") {
                                  $("#dialog-message").css({ visibility: "visible" }); //.css({ opacity: 0.0, visibility: "visible" }).animate({ opacity: 1.0 });
                                  $("#dialog-message").dialog({
                                      modal: true,
                                      buttons: {
                                          Ok: function () {
                                              $(this).dialog("close");
  
                                              window.location.reload();
                                          }
                                      }
                                  });
                              }
                              else {
                                  $.msgBox("Error! ");
                              }
                          }
                      });
                  }
                  else {
                      $.msgBox("There is an invalid email in the list.");
                  }
              }
              else {
                  $.msgBox("Please insert at least 1 recipient");
              }
          }
          else {
              $.msgBox("Please fill-in subject and message!");
          }
      });
  
  });
  </script>
<br />
<br />
<h2>
Job Management > Notification
  </h2>
<div id="dialog-message" title="Download complete" style="visibility:hidden">
<p>
  <span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
    Your message has been send.
    </p>
  </div>
<table>
<tr>
  <td style="width:80px">Subject</td>
    <td>@Html.TextBox("subject")</td>
    </tr>
  <tr>
  <td>Message</td>
    <td>@Html.TextArea("message", "", new { style = "width:400px; height: 200px;" })</td>
    </tr>
  </table>
<br />
<br />
<span class="sub_title">
List of recipients
  </span> 
<br />
<br />
<table id="tblRecipient">
</table>
<input type="button" value="Add new" id="btnAdd" /><input type="button" value="Sent" id="btnSent" />
